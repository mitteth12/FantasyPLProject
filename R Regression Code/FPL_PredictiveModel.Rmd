---
title: "FPL Ten Gameweek Predictive Model"
author: "Ethan Mitten"
date: "10/13/2021"
output: html_document
---

```{r}
#Load in packages
library(dplyr)
library(tidyverse)
```

```{r}
#Load in Beginning Data
FPL_1920 <- read.csv("~/Desktop/Data Analytics/Fantasy PL Project/FantasyPL_Data/2019-20/players_raw.csv")
FPL_2021 <- read.csv("~/Desktop/Data Analytics/Fantasy PL Project/FantasyPL_Data/2020-21/players_raw.csv")
NewFPL2021 <- read_csv("~/Desktop/Data Analytics/Fantasy PL Project/FantasyPL_Data/2020-21/players_raw.csv")
```

```{r}
FPL_1920 <- FPL_1920 %>% filter(total_points > 0)
FPL_1920 <- FPL_1920 %>% filter(assists > 0)
FPL_1920 <- FPL_1920 %>% filter(bonus > 0)
FPL_1920 <- FPL_1920 %>% filter(bps > 0)
FPL_1920 <- FPL_1920 %>% filter(goals_scored > 0)
FPL_1920 <- FPL_1920 %>% filter(influence > 0)
FPL_1920 <- FPL_1920 %>% filter(threat > 0)
FPL_1920 <- FPL_1920 %>% filter(minutes > 0)

NewFPL2021 <- NewFPL2021 %>% filter(total_points > 0)
NewFPL2021 <- NewFPL2021 %>% filter(assists > 0)
NewFPL2021 <- NewFPL2021 %>% filter(bonus > 0)
NewFPL2021 <- NewFPL2021 %>% filter(bps > 0)
NewFPL2021 <- NewFPL2021 %>% filter(goals_scored > 0)
NewFPL2021 <- NewFPL2021 %>% filter(influence > 0)
NewFPL2021 <- NewFPL2021 %>% filter(threat > 0)
NewFPL2021 <- NewFPL2021 %>% filter(minutes > 0)
```


```{r}
#Make linear regression model based on best model from other markdown sheet
library(SciViews)
model <- lm(ln(total_points) ~ scale(assists) + scale(bonus) + scale(bps) + scale(goals_scored) + scale(influence) + scale(threat) + scale(minutes) , data = NewFPL2021)
summary(model)
```

```{r}
#Make linear regression model for non-scaled data
model1 <- lm(total_points ~ assists + bonus + bps + goals_scored + influence + threat + minutes, data = NewFPL2021)
```

```{r}
#Assumption Modeling
tresid1 <- rstudent(model)
par(mfrow = c(1,2))
qqnorm(tresid1, pch=20)
qqline(tresid1, col="blue")
hist(tresid1)
plot(model$fitted.values, tresid1, pch=20)
abline(h=0)
plot(tresid1, type="o", pch=20)
abline(h=0)
```



```{r}
FPL_1920$scale_assists <- scale(FPL_1920$assists)
FPL_1920$scale_bonus <- scale(FPL_1920$bonus)
FPL_1920$scale_bps <- scale(FPL_1920$bps)
FPL_1920$scale_goals_scored <- scale(FPL_1920$goals_scored)
FPL_1920$scale_influence <- scale(FPL_1920$influence)
FPL_1920$scale_threat <- scale(FPL_1920$threat)
FPL_1920$scale_minutes <- scale(FPL_1920$minutes)
FPL_1920$ln_totalpoints <- ln(FPL_1920$total_points)
```

```{r}
New1920 <- FPL_1920 %>% select(c(scale_assists, scale_bonus, scale_bps, scale_goals_scored, scale_influence, scale_threat, scale_minutes, ln_totalpoints, first_name, second_name))
```

```{r}
#Rename columns in dataset
names(New1920)[names(New1920) == "ln_totalpoints"] <- "total_points"
names(New1920)[names(New1920) == "scale_assists"] <- "assists"
names(New1920)[names(New1920) == "scale_bonus"] <- "bonus"
names(New1920)[names(New1920) == "scale_bps"] <- "bps"
names(New1920)[names(New1920) == "scale_goals_scored"] <- "goals_scored"
names(New1920)[names(New1920) == "scale_influence"] <- "influence"
names(New1920)[names(New1920) == "scale_threat"] <- "threat"
names(New1920)[names(New1920) == "scale_minutes"] <- "minutes"
```


```{r}
#Predict values for 2019-20 season
prediction1920 <- predict(model, newdata = New1920)
New1920$prediction <- round(prediction1920,2)
New1920$difference <- round((New1920$prediction - (New1920$total_points)),2)
```


```{r}
#Look at distribution of difference values for 2019-20
ggplot(New1920, aes(x=difference)) +
  geom_boxplot()

mean(New1920$difference)
```

```{r}
FPL_2122 <- read.csv("~/Desktop/Data Analytics/Fantasy PL Project/FantasyPL_Data/FPLCurrentYearPredict.csv")
```

```{r}
FPL_2122 <- FPL_2122 %>% select(-c(clean.sheets, saves.))
```

```{r}
FPL_2122 <- FPL_2122 %>% filter(total.points > 0)
FPL_2122 <- FPL_2122 %>% filter(assists. > 0)
FPL_2122 <- FPL_2122 %>% filter(bonus. > 0)
FPL_2122 <- FPL_2122 %>% filter(bps. > 0)
FPL_2122 <- FPL_2122 %>% filter(goals.scored > 0)
FPL_2122 <- FPL_2122 %>% filter(influence. > 0)
FPL_2122 <- FPL_2122 %>% filter(threat. > 0)
FPL_2122 <- FPL_2122 %>% filter(minutes. > 0)
```

```{r}
FPL_2122$scale_assists <- scale(FPL_2122$assists.)
FPL_2122$scale_bonus <- scale(FPL_2122$bonus.)
FPL_2122$scale_bps <- scale(FPL_2122$bps.)
FPL_2122$scale_goals_scored <- scale(FPL_2122$goals.scored)
FPL_2122$scale_influence <- scale(FPL_2122$influence.)
FPL_2122$scale_threat <- scale(FPL_2122$threat.)
FPL_2122$scale_minutes <- scale(FPL_2122$minutes.)
FPL_2122$ln_totalpoints <- ln(FPL_2122$total.points)
```

```{r}
New2122 <- FPL_2122 %>% select(c(scale_assists, scale_bonus, scale_bps, scale_goals_scored, scale_influence, scale_threat, scale_minutes, ln_totalpoints, name))
```

```{r}
names(New2122)[names(New2122) == "ln_totalpoints"] <- "total_points"
names(New2122)[names(New2122) == "scale_assists"] <- "assists"
names(New2122)[names(New2122) == "scale_bonus"] <- "bonus"
names(New2122)[names(New2122) == "scale_bps"] <- "bps"
names(New2122)[names(New2122) == "scale_goals_scored"] <- "goals_scored"
names(New2122)[names(New2122) == "scale_influence"] <- "influence"
names(New2122)[names(New2122) == "scale_threat"] <- "threat"
names(New2122)[names(New2122) == "scale_minutes"] <- "minutes"
```

```{r}
prediction_2122 <- predict(model, newdata = New2122)
New2122$prediction <- round(prediction_2122,3)
New2122$difference <- round((New2122$prediction - New2122$total_points),3)
```


```{r}
ggplot(New2122, aes(x=difference)) +
  geom_boxplot()

mean(New2122$difference)
```

#Looking at the model I can use the difference column to see who is projected to have more points than they have at the moment. Gabriel Jesus is at the top of the list with surprisingly Michail Antonio. I have overlooked Antonio as I felt he was overhyped, but so far the data is suggesting good things from both of these players. In terms of who has the highest projected points. My team holds five of the top 20 projected players in it. 

```{r}
#Insert in New Gameweeks
gw8 <- read.csv("~/Desktop/Data Analytics/Fantasy PL Project/FantasyPL_Data/2021-22/gw8.csv")
gw9 <- read.csv("~/Desktop/Data Analytics/Fantasy PL Project/FantasyPL_Data/2021-22/gw9.csv")
gw10 <- read.csv("~/Desktop/Data Analytics/Fantasy PL Project/FantasyPL_Data/2021-22/gw10.csv")
gw11 <- read.csv("~/Desktop/Data Analytics/Fantasy PL Project/FantasyPL_Data/2021-22/gw11.csv")
gw12 <- read.csv("~/Desktop/Data Analytics/Fantasy PL Project/FantasyPL_Data/2021-22/gw12.csv")
gw13 <- read.csv("~/Desktop/Data Analytics/Fantasy PL Project/FantasyPL_Data/2021-22/gw13.csv")
#gw14 <- read.csv("~/Desktop/Data Analytics/Fantasy PL Project/FantasyPL_Data/2021-22/gw14.csv")

#Just keep adding gameweeks to keep it going
```

```{r}
#Make a function to quickly select only the columns we want from each dataset
gameweek_column_cleaner <- function(gameweek_variable) {
  gameweek_variable %>% select(c(total_points,assists,bonus,bps,goals_scored,influence,minutes,threat,name)) 
}
```

```{r}
#Put in gameweek
gw8 <- gameweek_column_cleaner(gw8)
gw9 <- gameweek_column_cleaner(gw9)
gw10 <- gameweek_column_cleaner(gw10)
gw11 <- gameweek_column_cleaner(gw11)
gw12 <- gameweek_column_cleaner(gw12)
gw13 <- gameweek_column_cleaner(gw13)
#gw14 <- gameweek_column_cleaner(gw14)

```

```{r}
#Bring in Clean Dataset for 2021-22 Season
Base_GW <- read.csv("~/Desktop/Data Analytics/Fantasy PL Project/FantasyPL_Data/FPLCurrentYearPredict.csv")
Base_GW <- Base_GW %>% select(-c(clean.sheets, saves.))
```

```{r}
#Rename columns in dataset
names(Base_GW)[names(Base_GW) == "total.points"] <- "total_points"
names(Base_GW)[names(Base_GW) == "assists."] <- "assists"
names(Base_GW)[names(Base_GW) == "bonus."] <- "bonus"
names(Base_GW)[names(Base_GW) == "bps."] <- "bps"
names(Base_GW)[names(Base_GW) == "goals.scored"] <- "goals_scored"
names(Base_GW)[names(Base_GW) == "influence."] <- "influence"
names(Base_GW)[names(Base_GW) == "threat."] <- "threat"
names(Base_GW)[names(Base_GW) == "minutes."] <- "minutes"
```


```{r}
#Keep adding to make next projections
gw8_projections <- rbind(Base_GW, gw8)
gw9_projections <- rbind(gw8_projections, gw9)
gw10_projections <- rbind(gw9_projections, gw10)
gw11_projections <- rbind(gw10_projections, gw11)
gw12_projections <- rbind(gw11_projections, gw12)
gw13_projections <- rbind(gw12_projections, gw13)
#gw14_projections <- rbind(gw13_projections, gw14)

#Current Week's Projection Model
X = gw13_projections
```

```{r}
#Accumulated Total for Columns
X <- X %>% 
    group_by(name) %>% 
    summarise_each(list(sum))
```

```{r}
#Duplicate X dataset for scaled (XX) dataset
XX = X
```

```{r}
#Take Out 0 values for natural log scaling
XX <- XX %>% filter(total_points > 0)
XX <- XX %>% filter(assists > 0)
XX <- XX %>% filter(bonus > 0)
XX <- XX %>% filter(bps > 0)
XX <- XX %>% filter(goals_scored > 0)
XX <- XX %>% filter(influence > 0)
XX <- XX %>% filter(threat > 0)
XX <- XX %>% filter(minutes > 0)
```

```{r}
#Make new columns for scaled variables
XX$assists <- scale(XX$assists)
XX$bonus <- scale(XX$bonus)
XX$bps <- scale(XX$bps)
XX$goals_scored <- scale(XX$goals_scored)
XX$influence <- scale(XX$influence)
XX$threat <- scale(XX$threat)
XX$minutes <- scale(XX$minutes)
XX$total_points <- ln(XX$total_points)
```

```{r}
#Model Predictions for Each Current Gameweek
live_predictions <- predict(model, newdata = XX)
XX$prediction <- round(live_predictions,3)
XX$difference <- round((XX$prediction - XX$total_points),3)

live_predictions1 <- predict(model1, newdata = X)
X$prediction <- round(live_predictions1,3)
X$difference <- round((X$prediction - X$total_points),3)
```


```{r}
#Graph and Evaluate Each Weeks Performance
ggplot(XX, aes(x=difference)) +
  geom_boxplot()

mean(XX$difference)
```
```{r}
#Keep Only the Most Current Observation for Each Player
XX <- XX %>% distinct(name, .keep_all=TRUE)
```

```{r}
#Take out duplicate name of Ben Davies (Sorry Both Ben Davies)
XX <- subset(XX, name != "Ben Davies")
X <- subset(X, name != "Ben Davies")
```


Week 8

#Still has similar people holding the highest predictive differences. Gabriel Jesus, Michail Antonio, Romelu Lukaku...

Week 9

#The model has been changed and is following a scaled transformation for now, so what is seen is that some players that are expected to score more points are:

*Dennis
*Kane 
*McGinn
*Smith-Rowe
*Salah
*Keita
*Bailey
*Richarlison
*Jones
*Werner
*Foden

#We will see how this players trend in the coming weeks and how this list moves

Week 10...

#A lot of movement this week and Jarrod Bowen for West Ham takes a clear number one spot with his residual value being one. Dennis, Kane, McGinn and Smith-Rowe continue to be up there. Ronaldo has also pushed his way into the conversation as well, so we will continue to keep track of these players. More closely we will keep track of Bowen, McGinn and Smith-Rowe as we are most concerned with midfielders.


Week 11...

#Jarrod Bowen got two assists this week and still looks to be evaluated by the model as continuing to keep this going with the statistics he has going. Dennis from Watford also is predicted to be doing better. Some other players to watch out for are Ronaldo, Kane and Trent Alexander-Arnold. Ronaldo and Kane are really expensive picks to randomly get and Alexander-Arnold is already in the side. Smith Rowe continues to do good as ever since he has been predicted to do good he has scored a goal in each week which is cool to see. My success story of the model.


Week 12...

#Saint-Maximin really jumped and is now first in the difference between predicted and actual. I have him in fantasy and hopefully this turns into more results rather than what it could also turn into which is just unproduction from Saint-Maximin. Bowen and Dennis are still high up on the ranks. Ronaldo Kane and Trent are also still up at the top. The only one that really has not produced out of the names listed is Kane, so interesting to see if he starting picking it up. Will continue to keep an eye on Bowen and how he does compared to his teammate Benrahama 

Week 13...

#I fixed the model to work how I want it to. It might take some modification of the original model that was used, but now we have two different modeling results to go off of which is great. I see Dennis high in both and although I personally do not know if much will come from that, getting Dennis gets me a chance to get Jota which using quantitative and qualitative data analytics since minutes is important and he plays on Liverpool he has an excellent opportunity to get points with the absence of Roberto Firmino.

Week 14...

#























