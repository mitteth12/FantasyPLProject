---
title: "FPL Gameweek Predictive Model"
author: "Ethan Mitten"
date: "10/13/2021"
output: html_document
---

```{r}
#Load in packages
library(dplyr)
library(tidyverse)
```

```{r}
#Load in Beginning Data
FPL_1920 <- read.csv("~/Desktop/Data Analytics/Fantasy PL Project/FantasyPL_Data/2019-20/players_raw.csv")
FPL_2021 <- read.csv("~/Desktop/Data Analytics/Fantasy PL Project/FantasyPL_Data/2020-21/players_raw.csv")
NewFPL2021 <- read_csv("~/Desktop/Data Analytics/Fantasy PL Project/FantasyPL_Data/2020-21/players_raw.csv")
```

```{r}
FPL_1920 <- FPL_1920 %>% filter(total_points > 0)
FPL_1920 <- FPL_1920 %>% filter(assists > 0)
FPL_1920 <- FPL_1920 %>% filter(bonus > 0)
FPL_1920 <- FPL_1920 %>% filter(bps > 0)
FPL_1920 <- FPL_1920 %>% filter(goals_scored > 0)
FPL_1920 <- FPL_1920 %>% filter(influence > 0)
FPL_1920 <- FPL_1920 %>% filter(threat > 0)
FPL_1920 <- FPL_1920 %>% filter(minutes > 0)

NewFPL2021 <- NewFPL2021 %>% filter(total_points > 0)
#NewFPL2021 <- NewFPL2021 %>% filter(assists > 0)
#NewFPL2021 <- NewFPL2021 %>% filter(bonus > 0)
#NewFPL2021 <- NewFPL2021 %>% filter(bps > 0)
#NewFPL2021 <- NewFPL2021 %>% filter(goals_scored > 0)
#NewFPL2021 <- NewFPL2021 %>% filter(influence > 0)
#NewFPL2021 <- NewFPL2021 %>% filter(threat > 0)
#NewFPL2021 <- NewFPL2021 %>% filter(minutes > 0)
```


```{r}
#Make linear regression model based on best model from other markdown sheet
library(SciViews)

example_model1 <- lm(total_points ~ assists + bonus + bps + goals_scored + influence + minutes + threat, data=NewFPL2021)

wts <- 1/fitted(lm(abs(residuals(example_model1)) ~ fitted(example_model1)))^2

model <- lm(total_points ~ assists + bonus + bps + goals_scored + influence + minutes+ threat, data=NewFPL2021, weights = wts)
summary(model)
```

```{r}
#Make linear regression model for non-scaled data
model1 <- lm(total_points ~ assists + bonus + bps + goals_scored + influence + threat + minutes, data = NewFPL2021)
```

```{r}
#Assumption Modeling
tresid1 <- rstudent(model)
par(mfrow = c(1,2))
qqnorm(tresid1, pch=20)
qqline(tresid1, col="blue")
hist(tresid1)
plot(model$fitted.values, tresid1, pch=20)
abline(h=0)
plot(tresid1, type="o", pch=20)
abline(h=0)
```



```{r}
FPL_1920$scale_assists <- scale(FPL_1920$assists)
FPL_1920$scale_bonus <- scale(FPL_1920$bonus)
FPL_1920$scale_bps <- scale(FPL_1920$bps)
FPL_1920$scale_goals_scored <- scale(FPL_1920$goals_scored)
FPL_1920$scale_influence <- scale(FPL_1920$influence)
FPL_1920$scale_threat <- scale(FPL_1920$threat)
FPL_1920$scale_minutes <- scale(FPL_1920$minutes)
FPL_1920$ln_totalpoints <- ln(FPL_1920$total_points)
```

```{r}
New1920 <- FPL_1920 %>% select(c(scale_assists, scale_bonus, scale_bps, scale_goals_scored, scale_influence, scale_threat, scale_minutes, ln_totalpoints, first_name, second_name))
```

```{r}
#Rename columns in dataset
names(New1920)[names(New1920) == "ln_totalpoints"] <- "total_points"
names(New1920)[names(New1920) == "scale_assists"] <- "assists"
names(New1920)[names(New1920) == "scale_bonus"] <- "bonus"
names(New1920)[names(New1920) == "scale_bps"] <- "bps"
names(New1920)[names(New1920) == "scale_goals_scored"] <- "goals_scored"
names(New1920)[names(New1920) == "scale_influence"] <- "influence"
names(New1920)[names(New1920) == "scale_threat"] <- "threat"
names(New1920)[names(New1920) == "scale_minutes"] <- "minutes"
```


```{r}
#Predict values for 2019-20 season
#prediction1920 <- predict(model, newdata = New1920)
#New1920$prediction <- round(prediction1920,2)
#New1920$difference <- round((New1920$prediction - (New1920$total_points)),2)
```


```{r}
#Look at distribution of difference values for 2019-20
#ggplot(New1920, aes(x=difference)) +
  #geom_boxplot()

#mean(New1920$difference)
```

```{r}
FPL_2122 <- read.csv("~/Desktop/Data Analytics/Fantasy PL Project/FantasyPL_Data/FPLCurrentYearPredict.csv")
```

```{r}
FPL_2122 <- FPL_2122 %>% select(-c(clean.sheets, saves.))
```

```{r}
FPL_2122 <- FPL_2122 %>% filter(total.points > 0)
FPL_2122 <- FPL_2122 %>% filter(assists. > 0)
FPL_2122 <- FPL_2122 %>% filter(bonus. > 0)
FPL_2122 <- FPL_2122 %>% filter(bps. > 0)
FPL_2122 <- FPL_2122 %>% filter(goals.scored > 0)
FPL_2122 <- FPL_2122 %>% filter(influence. > 0)
FPL_2122 <- FPL_2122 %>% filter(threat. > 0)
FPL_2122 <- FPL_2122 %>% filter(minutes. > 0)
```

```{r}
FPL_2122$scale_assists <- scale(FPL_2122$assists.)
FPL_2122$scale_bonus <- scale(FPL_2122$bonus.)
FPL_2122$scale_bps <- scale(FPL_2122$bps.)
FPL_2122$scale_goals_scored <- scale(FPL_2122$goals.scored)
FPL_2122$scale_influence <- scale(FPL_2122$influence.)
FPL_2122$scale_threat <- scale(FPL_2122$threat.)
FPL_2122$scale_minutes <- scale(FPL_2122$minutes.)
FPL_2122$ln_totalpoints <- ln(FPL_2122$total.points)
```

```{r}
New2122 <- FPL_2122 %>% select(c(scale_assists, scale_bonus, scale_bps, scale_goals_scored, scale_influence, scale_threat, scale_minutes, ln_totalpoints, name))
```

```{r}
names(New2122)[names(New2122) == "ln_totalpoints"] <- "total_points"
names(New2122)[names(New2122) == "scale_assists"] <- "assists"
names(New2122)[names(New2122) == "scale_bonus"] <- "bonus"
names(New2122)[names(New2122) == "scale_bps"] <- "bps"
names(New2122)[names(New2122) == "scale_goals_scored"] <- "goals_scored"
names(New2122)[names(New2122) == "scale_influence"] <- "influence"
names(New2122)[names(New2122) == "scale_threat"] <- "threat"
names(New2122)[names(New2122) == "scale_minutes"] <- "minutes"
```

```{r}
#prediction_2122 <- predict(model, newdata = New2122)
#New2122$prediction <- round(prediction_2122,3)
#New2122$difference <- round((New2122$prediction - New2122$total_points),3)
```


```{r}
#ggplot(New2122, aes(x=difference)) +
  #geom_boxplot()

#mean(New2122$difference)
```

#Looking at the model I can use the difference column to see who is projected to have more points than they have at the moment. Gabriel Jesus is at the top of the list with surprisingly Michail Antonio. I have overlooked Antonio as I felt he was overhyped, but so far the data is suggesting good things from both of these players. In terms of who has the highest projected points. My team holds five of the top 20 projected players in it. 

```{r}
#Insert in New Gameweeks
gw8 <- read.csv("~/Desktop/Data Analytics/Fantasy PL Project/FantasyPL_Data/2021-22/gw8.csv")
gw9 <- read.csv("~/Desktop/Data Analytics/Fantasy PL Project/FantasyPL_Data/2021-22/gw9.csv")
gw10 <- read.csv("~/Desktop/Data Analytics/Fantasy PL Project/FantasyPL_Data/2021-22/gw10.csv")
gw11 <- read.csv("~/Desktop/Data Analytics/Fantasy PL Project/FantasyPL_Data/2021-22/gw11.csv")
gw12 <- read.csv("~/Desktop/Data Analytics/Fantasy PL Project/FantasyPL_Data/2021-22/gw12.csv")
gw13 <- read.csv("~/Desktop/Data Analytics/Fantasy PL Project/FantasyPL_Data/2021-22/gw13.csv")
gw14 <- read.csv("~/Desktop/Data Analytics/Fantasy PL Project/FantasyPL_Data/2021-22/gw14.csv")
gw15 <- read.csv("~/Desktop/Data Analytics/Fantasy PL Project/FantasyPL_Data/2021-22/gw15.csv")
gw16 <- read.csv("~/Desktop/Data Analytics/Fantasy PL Project/FantasyPL_Data/2021-22/gw16.csv")
gw17 <- read.csv("~/Desktop/Data Analytics/Fantasy PL Project/FantasyPL_Data/2021-22/gw17.csv")
gw18 <- read.csv("~/Desktop/Data Analytics/Fantasy PL Project/FantasyPL_Data/2021-22/gw18.csv")
gw19 <- read.csv("~/Desktop/Data Analytics/Fantasy PL Project/FantasyPL_Data/2021-22/gw19.csv")
gw20 <- read.csv("~/Desktop/Data Analytics/Fantasy PL Project/FantasyPL_Data/2021-22/gw20.csv")
gw21 <- read.csv("~/Desktop/Data Analytics/Fantasy PL Project/FantasyPL_Data/2021-22/gw21.csv")
gw22 <- read.csv("~/Desktop/Data Analytics/Fantasy PL Project/FantasyPL_Data/2021-22/gw22.csv")
gw23 <- read.csv("~/Desktop/Data Analytics/Fantasy PL Project/FantasyPL_Data/2021-22/gw23.csv")
gw24 <- read.csv("~/Desktop/Data Analytics/Fantasy PL Project/FantasyPL_Data/2021-22/gw24.csv")
gw25 <- read.csv("~/Desktop/Data Analytics/Fantasy PL Project/FantasyPL_Data/2021-22/gw25.csv")
gw26 <- read.csv("~/Desktop/Data Analytics/Fantasy PL Project/FantasyPL_Data/2021-22/gw26.csv")
gw27 <- read.csv("~/Desktop/Data Analytics/Fantasy PL Project/FantasyPL_Data/2021-22/gw27.csv")
gw28 <- read.csv("~/Desktop/Data Analytics/Fantasy PL Project/FantasyPL_Data/2021-22/gw28.csv")
gw29 <- read.csv("~/Desktop/Data Analytics/Fantasy PL Project/FantasyPL_Data/2021-22/gw29.csv")
gw30 <- read.csv("~/Desktop/Data Analytics/Fantasy PL Project/FantasyPL_Data/2021-22/gw30.csv")
gw31 <- read.csv("~/Desktop/Data Analytics/Fantasy PL Project/FantasyPL_Data/2021-22/gw31.csv")
gw32 <- read.csv("~/Desktop/Data Analytics/Fantasy PL Project/FantasyPL_Data/2021-22/gw32.csv")
gw33 <- read.csv("~/Desktop/Data Analytics/Fantasy PL Project/FantasyPL_Data/2021-22/gw33.csv")
gw34 <- read.csv("~/Desktop/Data Analytics/Fantasy PL Project/FantasyPL_Data/2021-22/gw34.csv")
gw35 <- read.csv("~/Desktop/Data Analytics/Fantasy PL Project/FantasyPL_Data/2021-22/gw35.csv")
gw36 <- read.csv("~/Desktop/Data Analytics/Fantasy PL Project/FantasyPL_Data/2021-22/gw36.csv")
#gw37 <- read.csv("~/Desktop/Data Analytics/Fantasy PL Project/FantasyPL_Data/2021-22/gw37.csv")
#gw38 <- read.csv("~/Desktop/Data Analytics/Fantasy PL Project/FantasyPL_Data/2021-22/gw38.csv")

#Just keep adding gameweeks to keep it going
```

```{r}
#Make a function to quickly select only the columns we want from each dataset
gameweek_column_cleaner <- function(gameweek_variable) {
  gameweek_variable %>% select(c(total_points,assists,bonus,bps,goals_scored,influence,minutes,threat,name)) 
}
```

```{r}
#Put in gameweek
gw8 <- gameweek_column_cleaner(gw8)
gw9 <- gameweek_column_cleaner(gw9)
gw10 <- gameweek_column_cleaner(gw10)
gw11 <- gameweek_column_cleaner(gw11)
gw12 <- gameweek_column_cleaner(gw12)
gw13 <- gameweek_column_cleaner(gw13)
gw14 <- gameweek_column_cleaner(gw14)
gw15 <- gameweek_column_cleaner(gw15)
gw16 <- gameweek_column_cleaner(gw16)
gw17 <- gameweek_column_cleaner(gw17)
gw18 <- gameweek_column_cleaner(gw18)
gw19 <- gameweek_column_cleaner(gw19)
gw20 <- gameweek_column_cleaner(gw20)
gw21 <- gameweek_column_cleaner(gw21)
gw22 <- gameweek_column_cleaner(gw22)
gw23 <- gameweek_column_cleaner(gw23)
gw24 <- gameweek_column_cleaner(gw24)
gw25 <- gameweek_column_cleaner(gw25)
gw26 <- gameweek_column_cleaner(gw26)
gw27 <- gameweek_column_cleaner(gw27)
gw28 <- gameweek_column_cleaner(gw28)
gw29 <- gameweek_column_cleaner(gw29)
gw30 <- gameweek_column_cleaner(gw30)
gw31 <- gameweek_column_cleaner(gw31)
gw32 <- gameweek_column_cleaner(gw32)
gw33 <- gameweek_column_cleaner(gw33)
gw34 <- gameweek_column_cleaner(gw34)
gw35 <- gameweek_column_cleaner(gw35)
gw36 <- gameweek_column_cleaner(gw36)
#gw37 <- gameweek_column_cleaner(gw37)
#gw38 <- gameweek_column_cleaner(gw38)

```

```{r}
#Bring in Clean Dataset for 2021-22 Season
Base_GW <- read.csv("~/Desktop/Data Analytics/Fantasy PL Project/FantasyPL_Data/FPLCurrentYearPredict.csv")
Base_GW <- Base_GW %>% select(-c(clean.sheets, saves.))
```

```{r}
#Rename columns in dataset
names(Base_GW)[names(Base_GW) == "total.points"] <- "total_points"
names(Base_GW)[names(Base_GW) == "assists."] <- "assists"
names(Base_GW)[names(Base_GW) == "bonus."] <- "bonus"
names(Base_GW)[names(Base_GW) == "bps."] <- "bps"
names(Base_GW)[names(Base_GW) == "goals.scored"] <- "goals_scored"
names(Base_GW)[names(Base_GW) == "influence."] <- "influence"
names(Base_GW)[names(Base_GW) == "threat."] <- "threat"
names(Base_GW)[names(Base_GW) == "minutes."] <- "minutes"
```


```{r}
#Keep adding to make next projections
gw8_projections <- rbind(Base_GW, gw8)
gw9_projections <- rbind(gw8_projections, gw9)
gw10_projections <- rbind(gw9_projections, gw10)
gw11_projections <- rbind(gw10_projections, gw11)
gw12_projections <- rbind(gw11_projections, gw12)
gw13_projections <- rbind(gw12_projections, gw13)
gw14_projections <- rbind(gw13_projections, gw14)
gw15_projections <- rbind(gw14_projections, gw15)
gw16_projections <- rbind(gw15_projections, gw16)
gw17_projections <- rbind(gw16_projections, gw17)
gw18_projections <- rbind(gw17_projections, gw18)
gw19_projections <- rbind(gw18_projections, gw19)
gw20_projections <- rbind(gw19_projections, gw20)
gw21_projections <- rbind(gw20_projections, gw21)
gw22_projections <- rbind(gw21_projections, gw22)
gw23_projections <- rbind(gw22_projections, gw23)
gw24_projections <- rbind(gw23_projections, gw24)
gw25_projections <- rbind(gw24_projections, gw25)
gw26_projections <- rbind(gw25_projections, gw26)
gw27_projections <- rbind(gw26_projections, gw27)
gw28_projections <- rbind(gw27_projections, gw28)
gw29_projections <- rbind(gw28_projections, gw29)
gw30_projections <- rbind(gw29_projections, gw30)
gw31_projections <- rbind(gw30_projections, gw31)
gw32_projections <- rbind(gw31_projections, gw32)
gw33_projections <- rbind(gw32_projections, gw33)
gw34_projections <- rbind(gw33_projections, gw34)
gw35_projections <- rbind(gw34_projections, gw35)
gw36_projections <- rbind(gw35_projections, gw36)
#gw36_projections <- rbind(gw36_projections, gw37)
#gw36_projections <- rbind(gw37_projections, gw38)

#Last Week's Project Model
X = gw35_projections
#Current Week's Projection Model
XX = gw36_projections
```

```{r}
#Export X for Visualizations Purposes (Only Use For Updating Spreasdsheet/Do Only Once Every Two Months)
#Once Spreadsheet is Written Make a Column for Amount of Gameweeks in Team so Size Can be Used in Tableau

#write.csv(X,"~/Desktop/Data Analytics/Fantasy PL Project/FantasyPL_Data/2021-22/FPL21_22LiveStats.csv", row.names = FALSE)
```

```{r}
#Accumulated Total for Columns
XX <- XX %>% 
    group_by(name) %>% 
    summarise_each(list(sum))

X <- X %>% 
    group_by(name) %>% 
    summarise_each(list(sum))
```

```{r}
#Take Out 0 values for natural log scaling
XX <- XX %>% filter(total_points > 0)
X <- X %>% filter(total_points > 0)
#XX <- XX %>% filter(assists > 0)
#XX <- XX %>% filter(bonus > 0)
#XX <- XX %>% filter(bps > 0)
#XX <- XX %>% filter(goals_scored > 0)
#XX <- XX %>% filter(influence > 0)
#XX <- XX %>% filter(threat > 0)
#XX <- XX %>% filter(minutes > 0)
```

```{r}
#Make new columns for scaled variables
#XX$assists <- scale(XX$assists)
#XX$bonus <- scale(XX$bonus)
#XX$bps <- scale(XX$bps)
#XX$goals_scored <- scale(XX$goals_scored)
#XX$influence <- scale(XX$influence)
#XX$threat <- scale(XX$threat)
#XX$minutes <- scale(XX$minutes)
#XX$total_points <- ln(XX$total_points)
```

```{r}
#Model Predictions for Each Current Gameweek
live_predictions <- predict(model, newdata = XX)
XX$prediction <- round(live_predictions,3)
XX$difference <- round((XX$prediction - XX$total_points),3)

live_predictions1 <- predict(model, newdata = X)
X$prediction <- round(live_predictions1,3)
X$difference <- round((X$prediction - X$total_points),3)
```


```{r}
#Graph and Evaluate Each Weeks Performance
ggplot(XX, aes(x=difference)) +
  geom_boxplot()

median(XX$difference)
```
```{r}
#Keep Only the Most Current Observation for Each Player
XX <- XX %>% distinct(name, .keep_all=TRUE)
X <- X %>% distinct(name, .keep_all =TRUE)
```

```{r}
#Take out duplicate name of Ben Davies (Sorry Both Ben Davies)
XX <- subset(XX, name != "Ben Davies")
X <- subset(X, name != "Ben Davies")
```

```{r}
#https://stackoverflow.com/questions/26423493/r-rank-largest-to-smallest
XX$Rank <- round(rank(-XX$prediction),0)
X$Rank <- round(rank(-X$prediction),0)

XX$actual_rank <- round(rank(-XX$total_points),0)
```

```{r}
#New Dataset to Subtract Ranks From Gameweeks
#This Join Means That Players That Are New Will Not Be Added to Dataset Until After They Play in Two Gameweeks
XXX <- inner_join(XX,X, by="name")
XXX <- XXX %>% select(c(name,total_points.x,assists.x,bonus.x,bps.x,goals_scored.x,influence.x,minutes.x,threat.x,prediction.x,difference.x,actual_rank,Rank.x,Rank.y))
```

```{r}
#Subtract Ranks
#GW_Change is difference in PREDICTED ranks from gameweek to gameweek
XXX$GW_Change <- XXX$Rank.y - XXX$Rank.x
```

```{r}
#Final Clean Dataset to Look At
Final_Data <- XXX %>% select(-c(Rank.y))

names(Final_Data)[names(Final_Data) == "total_points.x"] <- "total_points"
names(Final_Data)[names(Final_Data) == "assists.x"] <- "assists"
names(Final_Data)[names(Final_Data) == "bonus.x"] <- "bonus"
names(Final_Data)[names(Final_Data) == "bps.x"] <- "bps"
names(Final_Data)[names(Final_Data) == "goals_scored.x"] <- "goals_scored"
names(Final_Data)[names(Final_Data) == "influence.x"] <- "influence"
names(Final_Data)[names(Final_Data) == "threat.x"] <- "threat"
names(Final_Data)[names(Final_Data) == "minutes.x"] <- "minutes"
names(Final_Data)[names(Final_Data) == "prediction.x"] <- "prediction"
names(Final_Data)[names(Final_Data) == "difference.x"] <- "difference"
names(Final_Data)[names(Final_Data) == "Rank.x"] <- "predicted_rank"
names(Final_Data)[names(Final_Data) == "GW_Change"] <- "predicted_gw_change"

Final_Data$total_contributions <- Final_Data$assists + Final_Data$goals_scored
```

```{r}
#Load in some player data
player_info <- read.csv("~/Desktop/Data Analytics/Fantasy PL Project/FantasyPL_Data/2021-22/fplplayer_info.csv")
```

```{r}
#Join in player info data
Final_Data <- left_join(Final_Data,player_info, by="name")
Final_Data <- Final_Data %>% select(c(name,pos,squad,actual_rank,predicted_rank,predicted_gw_change,total_points,prediction,difference,assists,bonus,bps,goals_scored,influence,minutes,threat,total_contributions,caps_for_fpl))
```

```{r}
#rank_difference is difference in actual rank vs. predicted rank for current gameweek
Final_Data$rank_difference <- Final_Data$actual_rank - Final_Data$predicted_rank
```

```{r}
#Quickly Reorganize Final Data Spreadsheet One More Time
Final_Data <- Final_Data %>% select(c(name,pos,squad,actual_rank,predicted_rank,rank_difference,predicted_gw_change,total_points,prediction,difference,assists,bonus,bps,goals_scored,influence,minutes,threat,total_contributions,caps_for_fpl))
```

```{r}
#Export Spreadsheet of Each Current Weeks New Predictions and Ranks (CHANGE EACH GAMEWEEK)
write.csv(Final_Data, "~/Desktop/Data Analytics/Fantasy PL Project/FantasyPL_Data/Ranks_and_Predictions_21-22/GW23_Update.csv")
```

```{r}
median_pos <- Final_Data %>% group_by(pos) %>% filter(pos != 'NA') %>% summarize(median(difference))
totalpoints_squads <- Final_Data %>% group_by(squad) %>% filter(squad != 'NA') %>% summarize(mean(total_points))
totalpoints_squads_pos <- Final_Data %>% group_by(squad,pos) %>% filter(squad != 'NA') %>% summarize(mean(total_points))
```

```{r}
Final_MF <- Final_Data %>% filter(pos == 'MF')
Final_DF <- Final_Data %>% filter(pos == 'DF')
Final_FW <- Final_Data %>% filter(pos == 'FW')
```

# Predictor for player form

```{r}
#Latest five projections; for each gameweek add and delete a gameweek
gw32_projectionsA <- rbind(gw32)
gw33_projectionsA <- rbind(gw32_projectionsA,gw33)
gw34_projectionsA <- rbind(gw33_projectionsA,gw34)
gw35_projectionsA <- rbind(gw34_projectionsA,gw35)
gw36_projectionsA <- rbind(gw35_projectionsA,gw36)
#gw36_projectionsA <- rbind(gw36_projectionsA,gw37)
#gw36_projectionsA <- rbind(gw37_projectionsA,gw38)

#Last Week's Project Model
Y = gw35_projectionsA
#Current Week's Projection Model
YY = gw36_projectionsA
```

```{r}
#Accumulated Total for Columns
YY <- YY %>% 
    group_by(name) %>% 
    summarise_each(list(sum))

Y <- Y %>% 
    group_by(name) %>% 
    summarise_each(list(sum))
```

```{r}
#Take Out 0 values for natural log scaling
YY <- YY %>% filter(total_points > 0)
Y <- Y %>% filter(total_points > 0)
#XX <- XX %>% filter(assists > 0)
#XX <- XX %>% filter(bonus > 0)
#XX <- XX %>% filter(bps > 0)
#XX <- XX %>% filter(goals_scored > 0)
#XX <- XX %>% filter(influence > 0)
#XX <- XX %>% filter(threat > 0)
#XX <- XX %>% filter(minutes > 0)
```

```{r}
#Make new columns for scaled variables
#XX$assists <- scale(XX$assists)
#XX$bonus <- scale(XX$bonus)
#XX$bps <- scale(XX$bps)
#XX$goals_scored <- scale(XX$goals_scored)
#XX$influence <- scale(XX$influence)
#XX$threat <- scale(XX$threat)
#XX$minutes <- scale(XX$minutes)
#XX$total_points <- ln(XX$total_points)
```

```{r}
#Model Predictions for Each Current Gameweek
live_predictionsA <- predict(model, newdata = YY)
YY$prediction <- round(live_predictionsA,3)
YY$difference <- round((YY$prediction - YY$total_points),3)

live_predictions1A <- predict(model, newdata = Y)
Y$prediction <- round(live_predictions1A,3)
Y$difference <- round((Y$prediction - Y$total_points),3)
```

```{r}
#Graph and Evaluate Each Weeks Performance
ggplot(YY, aes(x=difference)) +
  geom_boxplot()

median(YY$difference)
```

```{r}
#Keep Only the Most Current Observation for Each Player
YY <- YY %>% distinct(name, .keep_all=TRUE)
Y <- Y %>% distinct(name, .keep_all =TRUE)
```

```{r}
#Take out duplicate name of Ben Davies (Sorry Both Ben Davies)
YY <- subset(YY, name != "Ben Davies")
Y <- subset(Y, name != "Ben Davies")
```

```{r}
#https://stackoverflow.com/questions/26423493/r-rank-largest-to-smallest
YY$Rank <- round(rank(-YY$prediction),0)
Y$Rank <- round(rank(-Y$prediction),0)

YY$actual_rank <- round(rank(-YY$total_points),0)
```

```{r}
#New Dataset to Subtract Ranks From Gameweeks
#This Join Means That Players That Are New Will Not Be Added to Dataset Until After They Play in Two Gameweeks
YYY <- inner_join(YY,Y, by="name")
YYY <- YYY %>% select(c(name,total_points.x,assists.x,bonus.x,bps.x,goals_scored.x,influence.x,minutes.x,threat.x,prediction.x,difference.x,actual_rank,Rank.x,Rank.y))
```

```{r}
#Subtract Ranks
#GW_Change is difference in PREDICTED ranks from gameweek to gameweek
YYY$GW_Change <- YYY$Rank.y - YYY$Rank.x
```

```{r}
#Final Clean Dataset to Look At
Final_Data_Form <- YYY %>% select(-c(Rank.y))

names(Final_Data_Form)[names(Final_Data_Form) == "total_points.x"] <- "total_points"
names(Final_Data_Form)[names(Final_Data_Form) == "assists.x"] <- "assists"
names(Final_Data_Form)[names(Final_Data_Form) == "bonus.x"] <- "bonus"
names(Final_Data_Form)[names(Final_Data_Form) == "bps.x"] <- "bps"
names(Final_Data_Form)[names(Final_Data_Form) == "goals_scored.x"] <- "goals_scored"
names(Final_Data_Form)[names(Final_Data_Form) == "influence.x"] <- "influence"
names(Final_Data_Form)[names(Final_Data_Form) == "threat.x"] <- "threat"
names(Final_Data_Form)[names(Final_Data_Form) == "minutes.x"] <- "minutes"
names(Final_Data_Form)[names(Final_Data_Form) == "prediction.x"] <- "prediction"
names(Final_Data_Form)[names(Final_Data_Form) == "difference.x"] <- "difference"
names(Final_Data_Form)[names(Final_Data_Form) == "Rank.x"] <- "predicted_rank"
names(Final_Data_Form)[names(Final_Data_Form) == "GW_Change"] <- "predicted_gw_change"

Final_Data_Form$total_contributions <- Final_Data_Form$assists + Final_Data_Form$goals_scored
```

```{r}
#Join in player info data
Final_Data_Form <- left_join(Final_Data_Form,player_info, by="name")
Final_Data_Form <- Final_Data_Form %>% select(c(name,pos,squad,actual_rank,predicted_rank,predicted_gw_change,total_points,prediction,difference,assists,bonus,bps,goals_scored,influence,minutes,threat,total_contributions,caps_for_fpl))
```

```{r}
#rank_difference is difference in actual rank vs. predicted rank for current gameweek
Final_Data_Form$rank_difference <- Final_Data_Form$actual_rank - Final_Data_Form$predicted_rank
```

```{r}
#Quickly Reorganize Final Data Spreadsheet One More Time
Final_Data_Form <- Final_Data_Form %>% select(c(name,pos,squad,actual_rank,predicted_rank,rank_difference,predicted_gw_change,total_points,prediction,difference,assists,bonus,bps,goals_scored,influence,minutes,threat,total_contributions,caps_for_fpl))
```

## Week 8

Still has similar people holding the highest predictive differences. Gabriel Jesus, Michail Antonio, Romelu Lukaku...

## Week 9

The model has been changed and is following a scaled transformation for now, so what is seen is that some players that are expected to score more points are:

*Dennis
*Kane 
*McGinn
*Smith-Rowe
*Salah
*Keita
*Bailey
*Richarlison
*Jones
*Werner
*Foden

We will see how this players trend in the coming weeks and how this list moves

## Week 10...

A lot of movement this week and Jarrod Bowen for West Ham takes a clear number one spot with his residual value being one. Dennis, Kane, McGinn and Smith-Rowe continue to be up there. Ronaldo has also pushed his way into the conversation as well, so we will continue to keep track of these players. More closely we will keep track of Bowen, McGinn and Smith-Rowe as we are most concerned with midfielders.


## Week 11...

Jarrod Bowen got two assists this week and still looks to be evaluated by the model as continuing to keep this going with the statistics he has going. Dennis from Watford also is predicted to be doing better. Some other players to watch out for are Ronaldo, Kane and Trent Alexander-Arnold. Ronaldo and Kane are really expensive picks to randomly get and Alexander-Arnold is already in the side. Smith Rowe continues to do good as ever since he has been predicted to do good he has scored a goal in each week which is cool to see. My success story of the model.


## Week 12...

Saint-Maximin really jumped and is now first in the difference between predicted and actual. I have him in fantasy and hopefully this turns into more results rather than what it could also turn into which is just unproduction from Saint-Maximin. Bowen and Dennis are still high up on the ranks. Ronaldo Kane and Trent are also still up at the top. The only one that really has not produced out of the names listed is Kane, so interesting to see if he starting picking it up. Will continue to keep an eye on Bowen and how he does compared to his teammate Benrahama 

## Week 13...

I fixed the model to work how I want it to. It might take some modification of the original model that was used, but now we have two different modeling results to go off of which is great. I see Dennis high in both and although I personally do not know if much will come from that, getting Dennis gets me a chance to get Jota which using quantitative and qualitative data analytics since minutes is important and he plays on Liverpool he has an excellent opportunity to get points with the absence of Roberto Firmino.

## Week 14...

Vardy definitely looks to be the notable player out of this list that I do not have. Smith Rowe is still a player that is doing great in real life and on the predictive modeling, so trying to find a way to fit him in would be good thing. Interestingly enough Emmanuel Dennis actually scored against Chelsea and got 9 points in gameweek 13, so he is giving hope to this model doing a good job. Obviously, there are a lot of unpredictables, but these stats give a better pool too choose from. Bernardo Silva is definitely someone to keep an eye on, but salary seems to be an issue for the squad with having spent so much on my back line. 

## Week 15...

Dennis has stayed high up on the list and there is big momentum for Bernardo Silva and Mason Mount. Both players have flown up the charts and are now in the top 5 for predicted scorers. It looks like there are actually quite a few picks that have jumped over Emile Smith Rowe. However, Smith Rowe was injured the last game. Bernardo Silva seems to be the player to keep an eye on moving forward. 

## Week 16...

Bernardo Silva continues to rise along with Conor Gallagher. Antonio seems to still be a good buy, but I do not have the funds at the moment. Its a short turnaround to gameweek 17, so we are going to just hold and watch how things unfold and dissect a little more after.

## Week 17...

Mason Mount is now the 3rd most valuable player in our model for points. Gallagher continues to stay high up on the charts. Not much else has changed other than Smith Rowe rising as well.

## Week 18...

Given that there were only five games this gameweek there is not a lot to takeaway. With that there also was not very much movement in the players. Raphnina went up the charts, but he also had a game this weekend where as players like Tielemans did not. Our players that we have plucked from continue to be at the top of these lists.

## Week 19...

Mason Mount is someone that is really on my radar now and trying to find a way to get him into my side might be a postive move for the club. On the other hand, he has some bye weeks coming up as well as some bad matchups, so he could be an option to choose from in a couple of weeks from now. I think we are just going to hold tight. The only players that seem to be in contention for changing is Smith Rowe and Tielemans, but they have both been doing great when they have been playing.

## Week 20...

Not much movement other than Jarrod Bowen is continuing to climb. It is a little tough to really make too many interpretations as a lot of games are getting cancelled with covid, so some players are able to develop more statistics to help themselves climb the model. Once the games are balanced out again we will be able to get a more clear picture. 

## Week 21...

The one thing that is very obvious and sticks out is how much Jarrod Bowen is producing. The frustrating part is I have been writing about Bowen since Week 10 now and he has constantly been doing better and better and I still have not put him in the team. Having him in earlier could have really been beneficial, but regardless he is going in the team now. Besides Bowen not a whole lot of movement is seen. Dennis went down a bit this week, but everyone is pretty consistent. It looks like Rudiger may have jumped some placements as well.

## Week 22...

In our newly update version of this it looks like there is not a whole lot of movement. One player that has moved a little bit upwards was Bruno Fernandes this week who we did pick up. Ward-Prowse has really driven himself high up on the ranks as well. Somebody to watch for as well.

## Week 23...

Not too much movement going on this week. It can be seen that Andrew Robertson jumped 12 spots from last week. Vardy had a big drop in the rankings as well going down 7. Some of the movements need to be taken lightly as AFCON is going on which means that Sadio Mane and Said Benrahama are moving down just because they were not playing. Looking at matchups for next gameweek the change that should be done is taking Saka out and putting Gallagher in.

## Week 24...

Laporte and Diogo Jota are both on the move upwards. Will have to watch for them in the coming days. Other than that not too much movement going on besides Bernardo Silva slightly going down in the ranks. Might have to watch him the next couple of weeks. Might also be valuable to have a form predictor. In other words, who is at the top of the list based off of the last five games? I will make this and see what insights it might bring. Doesn't hurt to have more info available. I guess that is unless that info leads me in the wrong direction.

## Week 25...

Bernardo Silva, although at the top is not one of the players over the last five weeks who has been making any contributions. It might prove a bad idea to get rid of him in the team, but there is room to also add other people who might be doing just as good if not better than him. This one is a bit risky, but the data has shown that Coutinho coming to Aston Villa has been good for him and he is earning good points since starting. The logic is that people like Jack Harrison might have just found form, but Coutinho has only played about five games at Aston Villa and is at the top of the list from that. It tells me that this might have more longevity than someone like Jack Harrison. Jarrod Bowen has been so impressive and is now third behind the immovable Trent and Salah at the top. Bowen is a lock on midfielders and should be someone who continues to stay in the starting side. We still have the three best forwards in the league, but Maupay is high up there as well. Ward-Prowse is potentially someone to have eyes on in the next couple of weeks. Saka is pretty far down on the list of midfield choices, but with two games this upcoming gameweek he would be a good pick. 

## Week 26...

The thing that stands out to me the most from gameweek 26 going into gameweek 28 since the window between 26 and 27 was so small is Ramsey. Aston Villa has a double gameweek this upcoming week and Ramsey's form is towards the top of the list. Harry Kane has also really climbed into form as of recently and although I do not know where the funds would come from it would be worth to just keep tabs on Kane. I have the top 5 players right now although, Robertson is predicted higher than Van Dijk. My forwards still look strong being in the top 3 still. My midfielders are the ones that are a little different at the moment. I have 3 of the top 8 best players available for midfielders which is great and then Coutinho and Ramsey which Ramsey is 7th in form and Coutinho is 22nd at the moment. Considering they both have a double gameweek coming up this is a good sign. The data suggests that things are going smoothly in terms of the development of my side and from the application side I would say that is accurate.

## Week 27...

We have an interesting list of names on the top of the form chart. A lot of these players are not seen in the final dataset. We are looking for a player who is in good form and is also towards the top of the final dataset list. It can be seen that Harry Kane is making a little movement up the list and is also number one in form at the moment. We do not see too much movement other than that especially considering that our lineup was already set for gw28 before this list was even run. Jacob Ramsey dropped off quite a bit from the form list which was the only thing we were basing our pick from. Coutinho still feels like a good pick, but not a whole lot is suggesting Ramsey will offer much. However, he is Aston Villa so he has a double gameweek and has been getting minutes, so worst case scenario he gets 3 or 4 points over this gameweek.

## Week 28...

Matty Cash and Coutinho were putting in good performances as of late. Had to make my lineup before I found this data, so not going to analyze too much this gameweek.

## Week 29...

It is interesting to see how form shifts from week to week. Kane, Kulusevski and Toney are the notable players. Kane has really worked his way up the actual final data charts as well. Toney has actually passed Dennis in the overall charts as well. Looking a little more in depth at positions we see Robertson has worked his way up into the top spots, but also Coady. For forwards Kane is now the top forward and Saint-Maximin has dropped a bit with being injured. The back half of the season has seen some shifts in the players taking the top spots. Not too much change has happened for the midfielders.

## Week 30...

Tottenham's striking force as a whole is very inform at the moment. The trio of Kane, Kulusevski and Son take the top three in-form players spots. Kane now moved into the top 5 for all top performers in the data. Kane is one that slipped away. Other people hopped on the inform play of Kane and I still couldn't see the pattern quick enough. It was going to be hard to bring in the funds to get him as well as finding the transfers to do it. However, it was a missed opportunity nonetheless and when it boils down to it those are mistakes that could dictate placement in the final stretch here. I think when analyzing movement I spent a little too much time looking at the top and not enough time in the meat of the data where the real moves were happening. What has been seen is those at the top are staying pretty consistent, but there are new emerging players meaning they are now getting a lot of total points and have been doing it recently.

## Week 31...

Tottenham again has really been showing up in form. They control 4 of the top 5 spots for the highest performers in the last five weeks. That speaks volumes. They also look to have some good matchups, so we will use our transfers this week to hop on the Spurs train. The Spurs player of choice is going to be Son over Harry Kane because I can afford Son. Again it looks like my defenders are still doing fine. All of them are in the top 6 besides Ruben Dias who has been hurt. If need be though, Matty Cash and Conor Coady are options. Toney has really been on the rise while the three forwards I have, slowly have been falling. A cheap option that could help me move in Son would be Pukki. Norwich has a lot of good matchups in coming with a last push to try to get out of relegation, so he might be a great option. I feel okay about the midfield as well. Three of my players are in the top 10 while one is a really cheap option to make way for Son to come in and Coutinho is high on the form list.

## Week 32...

Having Heung-Min Son as our captain and bringing him in became very beneficial. Furthermore, Pukki also got a goal last week. A lot of different players at the top of the form chart now. The player that we saw would be good for statistics, but went away from has now had some good form in Ivan Toney. Although there is a lot of movement in our form list there is not much movement in our season data which makes sense. With 32 games of data there is a lot less variation than with only the most recent 5 games.

## Week 33...

Really not a lot of movement this gameweek. Looks like Richarlison is finding some form, but other than that not a lot of change.

## Week 34...

Again not really a lot of movement. With only a couple weeks left the team is looking setup to finish off the season.

## Week 35...

We know that we have two transfers available this week. Hopefully the data will give us some insight on who are good matchups. Something that is not considered in the data, but for me is that playing a lesser opponent may be beneficial. We saw with the matrix we did earlier in the season that was not necessarily the case, but a combination of form and amount of gameweeks has led to some thoughts about data suggestions. I need to transfer out Pukki since Norwich has been relegated and Spurs have some tough games ahead, so I am making a bold move, but the data suggests Werner has been one of the best in the league in terms of form at the moment and Chelsea have a double gameweek. In order to facilitate Werner having good games Mount and Havertz will have to be part of that. In that case we have the trio of Chelsea players. The data says Mount and Werner might be quality picks right now and with Chelsea's schedule and double gameweek it might be worth the risk at the end of the season. The data if there was only one gameweek might suggest picking up the likes of Toney or Bowen, but seeing Werner where he is on the form list puts me in a position where I am going to go for it and hope for a little rise in all of the Chelsea's players points or at least have picked a couple of their stars of the next two games.

## Week 36...

De Bruyne moved up all the way to 5th from 13th in our overall ranking data. I captained him last week and his four goals proved to be vital to him moving up the rankings. Besides that not a whole lot of movement at the top. Sterling moved up a decent amount. In terms of form we have a pretty good mix of players with Son staying up at the top and Gabriel Jesus leading the pack.

## Week 37...


## Week 38...















